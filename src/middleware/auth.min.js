/*! oporrak 2023-05-17 */
import axios from"axios";import{createPublicKey,createSecretKey}from"crypto";import{V4,V3}from"paseto";import{tiposRol}from"../public/js/enumeraciones";import{publicKey,puertoAPI,secreto,serverAPI}from"../config/settings";const authRoutes=async(t,r,o)=>{let a=t.cookies.auth;try{const s=createSecretKey(new Buffer.from(secreto,"hex"));var e,i;void 0===a&&(a="",e="undefined"===t.query.valid?"":t.query.valid,i=createPublicKey({key:publicKey,format:"pem",type:"spki",passphrase:secreto}),await V4.verify(e,i,{audience:"urn:client:claim",issuer:"http://localhost:4000",clockTolerance:"1 min"}).then(async e=>{e={USERID:e.userid},e=await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuario`,{context:e}),e={id:e.data.data[0].IDUSUA,userid:e.data.data[0].USERID,rol:e.data.data[0].ROLUSU,oficina:e.data.data[0].OFIUSU};await V3.encrypt(e,s,{audience:"urn:example:client",issuer:"http://localhost:4000",expiresIn:"6 hours"}).then(e=>{a=e;r.cookie("auth",e,{path:"/",sameSite:!0,maxAge:216e5,httpOnly:!0}),r.cookie("verPan",1,{path:"/user"})}).catch(e=>{throw new Error(e)})}).catch(e=>{throw new Error(e)})),await V3.decrypt(a,s,{audience:"urn:example:client",issuer:"http://localhost:4000",clockTolerance:"1 min"}).then(e=>{t.user={id:e.id,userid:e.userid,rol:e.rol,oficina:e.oficina},o()}).catch(e=>{throw new Error(e)})}catch(e){return r.redirect("/")}},verifyTokenAndAdmin=(e,t,r)=>{authRoutes(e,t,()=>{e.user.rol===tiposRol.admin?r():t.status(410).json("No tienes autorización")})},verifyTokenAndResp=(e,t,r)=>{authRoutes(e,t,()=>{e.user.rol===tiposRol.responsable||e.user.rol===tiposRol.admin?r():t.status(410).json("No tienes autorización")})};export default authRoutes;export{verifyTokenAndAdmin,verifyTokenAndResp};