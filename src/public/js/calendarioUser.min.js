/*! oporrak 2023-05-16 */
const dateISOToUTCString=e=>{var e=new Date(e),t=6e4*e.getTimezoneOffset();return new Date(e.getTime()-t).toISOString().slice(0,10)},confirm=()=>(document.getElementById("eventos").value=JSON.stringify(eventos),!0),setSuccess=e=>{var t=e.parentElement;t.querySelector(".invalid-feedback").innerText="",t.classList.add("is-valid"),e.classList.remove("is-invalid")},setError=(e,t)=>{var a=e.parentElement;a.querySelector(".invalid-feedback").innerText=t,e.classList.add("is-invalid"),a.classList.remove("is-valid")},isInRange=(e,t)=>e>=t[0]&&e<=t[1],eventoRango=async()=>{const a=document.getElementById("deshor").value,s=document.getElementById("hashor").value,n=document.getElementById("msgfor");var e=document.getElementById("desfec").value,o=document.getElementById("hasfec").value;let r=!1,d=[];for(let t=new Date(e);t<=new Date(o)&&(dataSource.filter(e=>{e.startDate===t.toISOString().slice(0,10)&&d.push(e)}),!(0<d.length));t.setDate(t.getDate()+1));if(0<d.length&&d.every(e=>{var t=[e.deshor,e.hashor];return!isInRange(a,t)&&!isInRange(s,t)||(r=!0,setError(n,`Solape de eventos el d√≠a ${e.startDate.split("-").reverse().join("-")} `+a),setTimeout(function(){setSuccess(n)},3e3),!1)}),!r){for(var t=new Date(e);t<=new Date(o);t.setDate(t.getDate()+1)){var i,l=dateISOToUTCString(t);festivos.indexOf(l)<0&&0!==t.getDay()&&6!==t.getDay()&&(i=-Date.now(),dataSource.push({idesta:i,tipest:params.tipo,startDate:l,endDate:l,rangoH:`${params.nombre} (${a} a ${s})`,color:params.color,deshor:a,hashor:s}),eventos.push({idesta:i,fecest:l,tipest:params.tipo,deshor:`+00 ${a}:00`,hashor:`+00 ${s}:00`}))}getEstadosTipo(params.tipo),document.getElementById("modal-form").style.display="none"}},getEstadosTipo=t=>{var e=0===t?dataSource:dataSource.filter(e=>e.tipest===t);let a=[];e.map(e=>{a.push({idesta:e.idesta,tipest:e.tipest,startDate:new Date(e.startDate),endDate:new Date(e.endDate),rangoH:e.rangoH,color:e.color,deshor:e.deshor,hashor:e.hashor})}),calendario.setDataSource(a)},editEvento=e=>{var e=dateISOToUTCString(e.date),t=document.getElementById("modal-form");document.getElementById("desfec").value=e,document.getElementById("hasfec").value=e,params.tipo===tipos.baja.ID||params.tipo===tipos.formacion.ID?(document.getElementById("deshor").value="08:30",document.getElementById("hashor").value="14:00"):params.tipo===tipos.conciliacion.ID?(document.getElementById("deshor").value="08:30",document.getElementById("hashor").value="09:30"):params.tipo!==tipos.reunion.ID&&params.tipo!==tipos.horas.ID&&params.tipo!==tipos.telefono.ID||(document.getElementById("deshor").value="08:30",document.getElementById("hashor").value="14:00"),t.style.display="flex"},validate=(e,t)=>{if("0"===e.value)return setError(e,t),setTimeout(function(){setSuccess(e)},3e3),!1},deleteMenuEvent=async e=>{var t;e<0?(t=eventos.map(e=>e.idesta).indexOf(e),eventos.splice(t,1)):eventos.push({idesta:e,fecest:"",tipest:0,deshor:"",hashor:""}),pos=dataSource.map(e=>e.idesta).indexOf(e),dataSource.splice(pos,1);let a=[];dataSource.map(e=>{a.push({idesta:e.idesta,tipest:e.tipest,startDate:new Date(e.startDate),endDate:new Date(e.endDate),rangoH:e.rangoH,color:e.color,deshor:e.deshor,hashor:e.hashor})}),calendario.setDataSource(a),document.getElementById("btnEventCancel").click()};let calendario=null,currentYear=(new Date).getFullYear(),eventos=[],params={fecha:(new Date).toISOString().slice(0,10),nombre:"",tipo:0,color:"",desde:dateISOToUTCString(currentYear+"-01-01T00:00:00"),hasta:dateISOToUTCString(currentYear+"-12-31T00:00:00")};(calendario=new Calendar("#calendar",{minDate:new Date(params.desde),maxDate:new Date(params.hasta),language:"es",displayHeader:!1,mouseOnDay:function(e){if(0<e.events.length){let t="";e.events.forEach(e=>{t+=e.rangoH+"\n"}),e.element.setAttribute("data-bs-trigger","hover"),e.element.setAttribute("data-bs-toggle","popover"),e.element.setAttribute("title",t)}},customDayRenderer:function(e,t){var a=dateISOToUTCString(t);e.parentElement.classList.contains("festivo")&&e.parentElement.classList.remove("festivo"),-1!==festivos.indexOf(a)&&(e.style.color=tipos.festivo.COLOR,e.parentElement.classList.add("festivo")),0===t.getDay()&&(e.style.color=tipos.festivo.COLOR)},dataSource:function(){return dataSource.map(e=>({idesta:e.idesta,tipest:e.tipest,startDate:new Date(e.startDate),endDate:new Date(e.endDate),rangoH:e.rangoH,color:e.color,deshor:e.deshor,hashor:e.hashor}))}})).setYear(currentYear),document.getElementById("btnHorasCancel").addEventListener("click",function(){document.getElementById("modal-form").style.display="none"}),document.getElementById("btnEventCancel").addEventListener("click",function(){document.getElementById("modal-evnts").style.display="none"}),document.getElementById("btnSolapeAcept").addEventListener("click",function(){document.getElementById("modal-solape").style.display="none"}),document.addEventListener("keydown",function(e){var t=document.getElementById("modal-form"),a=document.getElementById("modal-evnts"),s=document.getElementById("modal-solape");"Escape"===e.key&&"flex"===t.style.display?t.style.display="none":"Escape"===e.key&&"flex"===a.style.display?a.style.display="none":"Escape"===e.key&&"flex"===s.style.display&&(s.style.display="none")}),document.getElementById("cboyea").addEventListener("change",function(){currentYear=parseInt(document.querySelector("#cboyea").value),params.desde=dateISOToUTCString(currentYear+"-01-01T00:00:00"),params.hasta=dateISOToUTCString(currentYear+"-12-31T00:00:00"),calendario.setMinDate(new Date(params.desde)),calendario.setMaxDate(new Date(params.hasta)),calendario.setYear(currentYear),getEstadosTipo(params.tipo)}),document.getElementById("cboest").addEventListener("change",function(){params.color=document.getElementById("cboest").options[document.getElementById("cboest").selectedIndex].getAttribute("data-foo"),params.tipo=parseInt(this.value),params.nombre=this.options[this.selectedIndex].text,getEstadosTipo(params.tipo)}),document.getElementById("calendar").addEventListener("clickDay",async function(a){if(!a.element.classList.contains("domingo"))if(0===a.events.length&&0===params.tipo)validate(document.getElementById("cboest"),"Estado requerido");else if(0!==a.events.length||params.tipo!==tipos.baja.ID&&params.tipo!==tipos.formacion.ID&&params.tipo!==tipos.conciliacion.ID&&params.tipo!==tipos.reunion.ID&&params.tipo!==tipos.horas.ID&&params.tipo!==tipos.telefono.ID)if(a.events.length)if(1<a.events.length){var e=document.getElementById("modal-evnts"),s=document.getElementById("table-body");let t="";s.innerHTML=t;for(let e=0;e<a.events.length;e++)t+=`<tr>
          <td>
            <div class="d-flex py-1 align-items-center">
              <div class="flex-fill">
                <div class="font-weight-medium" style="color: ${colores[a.events[e].tipest].COLOR}">${colores[a.events[e].tipest].DES}</div>
              </div>
            </div>
          </td>
          <td class="w-4">
            <div class="py-1 align-items-center">
              <a href="#" class="nav-link" onclick="deleteMenuEvent(${a.events[e].idesta})">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" height="24" width="24" viewBox="0 0 24 24" stroke="currentColor" fill="none"><path stroke-width=".4" fill="none" d="M7.85 19.575q-.6 0-1.025-.425-.425-.425-.425-1.025v-12.1h-.975V5.4h3.6v-.675H15V5.4h3.6v.625h-.975V18.15q0 .6-.425 1.013-.425.412-1.025.412Zm9.125-13.55H7.05v12.1q0 .35.225.575.225.225.575.225h8.325q.3 0 .55-.25.25-.25.25-.55Zm-6.85 10.925h.625V8h-.625Zm3.15 0h.625V8h-.625ZM7.05 6.025V18.925 18.125Z"/></svg>
              </a>
            </div>
          </td>
        </tr>`;s.innerHTML+=t,e.style.display="flex"}else{a.events[0].idesta<0?(s=eventos.map(e=>e.idesta).indexOf(a.events[0].idesta),eventos.splice(s,1)):eventos.push({idesta:a.events[0].idesta,fecest:"",tipest:0,deshor:"",hashor:""}),pos=dataSource.map(e=>e.idesta).indexOf(a.events[0].idesta),dataSource.splice(pos,1);let t=[];dataSource.map(e=>{t.push({idesta:e.idesta,tipest:e.tipest,startDate:new Date(e.startDate),endDate:new Date(e.endDate),rangoH:e.rangoH,color:e.color,deshor:e.deshor,hashor:e.hashor})}),calendario.setDataSource(t,{preventRendering:!1}),a.element.attributes.removeNamedItem("style")}else dataSource.find(e=>e.startDate===params.fecha)?(e=document.getElementById("modal-solape"),a.element.setAttribute("data-bs-trigger","hover"),a.element.setAttribute("data-bs-toggle","popover"),a.element.setAttribute("title","Solape de eventos"),e.style.display="flex"):(params.fecha=dateISOToUTCString(a.date),s=-Date.now(),dataSource.push({idesta:s,tipest:params.tipo,startDate:new Date(params.fecha),endDate:new Date(params.fecha),rangoH:params.nombre+" (08:30 a 14:00)",color:params.color}),eventos.push({idesta:s,fecest:params.fecha,tipest:params.tipo,deshor:"+00 08:30:00",hashor:"+00 14:00:00"}),calendario.setDataSource(dataSource,{preventRendering:!1}),a.element.style.boxShadow=params.color+" 0px -4px 0px 0px inset");else editEvento(a)});