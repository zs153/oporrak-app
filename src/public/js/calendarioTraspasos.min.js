/*! oporrak 2023-05-16 */
const getCookie=t=>{let a="";return document.cookie.split(";").forEach(e=>{e.includes(t)&&(a=e.split("=")[1])}),a},setCookie=(e,t,a)=>{let s="";var n;a&&((n=new Date).setTime(n.getTime()+24*a*60*60*1e3),s="; expires="+n.toUTCString()),document.cookie=e+"="+(t||"")+s+"; path=/"},deleteCookie=()=>{document.cookie="filtro=; expires=Thu, 01 Jan 1970 00:00:01 GMT; Path=/;"},setSuccess=e=>{var t=e.parentElement;t.querySelector(".invalid-feedback").innerText="",t.classList.add("is-valid"),e.classList.remove("is-invalid")},setError=(e,t)=>{var a=e.parentElement;a.querySelector(".invalid-feedback").innerText=t,e.classList.add("is-invalid"),a.classList.remove("is-valid")},validate=(e,t)=>{if("0"===e.value)return setError(e,t),setTimeout(function(){setSuccess(e)},3e3),!1},dateISOToUTCString=e=>{var e=new Date(e),t=6e4*e.getTimezoneOffset();return new Date(e.getTime()-t).toISOString().slice(0,10)},festivoOficina=async t=>{let e;var a;festivoLocal&&(pos=festivos.map(e=>e.FECFES).indexOf(festivoLocal),festivos.splice(pos,1)),festivoLocal=0===t?(e=dataSource,null):(a=festivosLocal[festivosLocal.map(e=>e.OFIFES).indexOf(t)],e=dataSource.filter(e=>e.ofiest===t),festivos.push(a),a.FECFES);let s=[];e.map(e=>{e={idesta:e.idesta,ofiest:e.ofiest,startDate:new Date(e.startDate),endDate:new Date(e.endDate),rangoH:e.rangoH,color:e.color};s.push(e)}),await calendario.setDataSource(s,{preventRendering:!0}),calendario.render()},confirm=()=>(document.getElementById("eventos").value=JSON.stringify(eventos),!0);let eventos=[],festivoLocal=null,calendario=null,currentYear=(new Date).getFullYear(),params={destino:0,nombre:"",color:"<%- datos.tiposEstado.traspaso.COLOR %>",desde:dateISOToUTCString(currentYear+"-01-01T00:00:00"),hasta:dateISOToUTCString(currentYear+"-12-31T00:00:00")};const elemUpd=document.getElementById("upd");elemUpd.setAttribute("action","/admin/traspasos/update?part="+getCookie("filtro")),(calendario=new Calendar("#calendar",{minDate:new Date(params.desde),maxDate:new Date(params.hasta),language:"es",displayHeader:!1,mouseOnDay:function(e){let t="";for(var a in e.events)t+=e.events[a].rangoH+"\n";e.element.setAttribute("data-bs-trigger","hover"),e.element.setAttribute("data-bs-toggle","popover"),e.element.setAttribute("title",t)},customDayRenderer:function(e,t){var a=new Date(t.getTime()-6e4*t.getTimezoneOffset()).toISOString().slice(0,10);e.parentElement.classList.contains("festivo")&&e.parentElement.classList.remove("festivo"),-1!==festivos.map(e=>e.FECFES).indexOf(a)&&(e.style.color="<%- datos.tiposEstado.festivo.COLOR %>",e.parentElement.classList.add("festivo")),0===t.getDay()&&(e.style.color="<%- datos.tiposEstado.festivo.COLOR %>")},dataSource:function(){return dataSource.map(e=>({idesta:e.idesta,ofiest:e.ofiest,startDate:new Date(e.startDate),endDate:new Date(e.endDate),rangoH:e.rangoH,color:e.color}))}})).setYear(currentYear),document.getElementById("btnSolapeAcept").addEventListener("click",function(){document.getElementById("modal-solape").style.display="none"}),document.getElementById("cboyea").addEventListener("change",function(){currentYear=parseInt(document.querySelector("#cboyea").value),params.desde=dateISOToUTCString(currentYear+"-01-01T00:00:00"),params.hasta=dateISOToUTCString(currentYear+"-12-31T00:00:00"),calendario.setMinDate(new Date(params.desde)),calendario.setMaxDate(new Date(params.hasta)),calendario.setYear(currentYear)}),document.getElementById("cbodes").addEventListener("change",function(){params.destino=parseInt(this.value),params.nombre=this.options[this.selectedIndex].text,festivoOficina(params.destino)}),document.querySelector("#calendar").addEventListener("clickDay",async function(e){if(!e.element.classList.contains("domingo")&&!e.element.classList.contains("festivo"))if(0===e.events.length&&0===params.destino)validate(document.getElementById("cbodes"),"Destino requerido");else if(params.fecha=new Date(e.date.getTime()-6e4*e.date.getTimezoneOffset()).toISOString().slice(0,10),e.events.length){var a=eventos.map(e=>e.fecest).indexOf(params.fecha),a=(-1!==a&&eventos.splice(a,1),0!==e.events[0].idesta&&eventos.push({idesta:e.events[0].idesta,fecest:params.fecha,ofiest:params.destino}),dataSource.map(e=>e.idesta).indexOf(e.events[0].idesta));dataSource.splice(a,1);let t=[];dataSource.map(e=>{e={idesta:e.idesta,ofiest:e.ofiest,startDate:new Date(e.startDate),endDate:new Date(e.endDate),rangoH:e.rangoH,color:e.color};t.push(e)}),calendario.setDataSource(t,{preventRendering:!1}),e.element.attributes.removeNamedItem("style")}else if(dataSource.find(e=>e.startDate===params.fecha))a=document.getElementById("modal-solape"),e.element.setAttribute("data-bs-trigger","hover"),e.element.setAttribute("data-bs-toggle","popover"),e.element.setAttribute("title","Solape de eventos"),a.style.display="flex";else{eventos.push({idesta:0,fecest:params.fecha,ofiest:params.destino});a={idesta:0,ofiest:params.destino,startDate:params.fecha,endDate:params.fecha,rangoH:params.nombre+`
(08:30 a 14:00)`,color:params.color};dataSource.push(a);let t=[];dataSource.map(e=>{e={idesta:e.idesta,ofiest:e.ofiest,startDate:new Date(e.startDate),endDate:new Date(e.endDate),rangoH:e.rangoH,color:e.color};t.push(e)}),calendario.setDataSource(t,{preventRendering:!1}),e.element.style.boxShadow=params.color+" 0px -4px 0px 0px inset"}});