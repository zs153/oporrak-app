/*! oporrak 2023-05-17 */
import axios from"axios";import{serverAPI,puertoAPI}from"../../config/settings";import{tiposRol,tiposMovimiento}from"../../public/js/enumeraciones";const mainPage=async(t,i)=>{var o=t.user,n=t.query.dir||"next",d=t.query.limit||10,r=t.query.part?t.query.part.toUpperCase():"";let p=!!(t=t.query.cursor?JSON.parse(t.query.cursor):null),c={};c=t?{limit:d+1,direction:n,cursor:JSON.parse(convertCursorToNode(JSON.stringify(t))),part:r}:{limit:d+1,direction:n,cursor:{next:0,prev:0},part:r};try{let r=(await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficinas`,{context:c})).data.data,e=r.length===d+1,a=0,s=0;e?(a=("next"===n?r[d-1]:r[0]).IDOFIC,s=("next"===n?r[0]:r[d-1]).IDOFIC,r.pop()):(a="next"===n?0:r[0]?.IDOFIC,s="next"===n?r[0]?.IDOFIC:0,p=t?(e=0!==a,0!==s):e=!1),"prev"===n&&(r=r.reverse());var t={next:a,prev:s},m={oficinas:r,hasNextOficinas:e,hasPrevOficinas:p,cursor:convertNodeToCursor(JSON.stringify(t))};i.render("admin/oficinas",{user:o,datos:m})}catch(r){400===r.response?.status?i.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):i.render("admin/error500",{alerts:[{msg:r}]})}},addPage=async(r,e)=>{r=r.user;try{e.render("admin/oficinas/add",{user:r})}catch(r){400===r.response?.status?e.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:r}]})}},editPage=async(r,e)=>{var a=r.user;try{var s={oficina:(await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficina`,{context:{IDOFIC:r.params.id}})).data.data[0],tiposRol:tiposRol};e.render("admin/oficinas/edit",{user:a,datos:s})}catch(r){400===r.response?.status?e.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:r}]})}},insert=async(r,e)=>{var a=r.user,s={DESOFI:r.body.desofi.toUpperCase(),CODOFI:r.body.codofi.toUpperCase()},a={USUMOV:a.id,TIPMOV:tiposMovimiento.crearOficina};try{await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficinas/insert`,{oficina:s,movimiento:a}),e.redirect("/admin/oficinas?part="+r.query.part)}catch(r){400===r.response?.status?e.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:r}]})}},update=async(r,e)=>{var a=r.user,s={IDOFIC:r.body.idofic,DESOFI:r.body.desofi.toUpperCase(),CODOFI:r.body.codofi.toUpperCase()},a={USUMOV:a.id,TIPMOV:tiposMovimiento.modificarOficina};try{await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficinas/update`,{oficina:s,movimiento:a}),e.redirect("/admin/oficinas?part="+r.query.part)}catch(r){400===r.response?.status?e.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:r}]})}},remove=async(r,e)=>{var a=r.user,s={IDOFIC:r.body.idofic},a={USUMOV:a.id,TIPMOV:tiposMovimiento.borrarOficina};try{await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficinas/delete`,{oficina:s,movimiento:a}),e.redirect("/admin/oficinas?part="+r.query.part)}catch(r){400===r.response?.status?e.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:r}]})}},convertNodeToCursor=r=>new Buffer.from(r,"binary").toString("base64"),convertCursorToNode=r=>new Buffer.from(r,"base64").toString("binary");export{mainPage,addPage,editPage,insert,update,remove};