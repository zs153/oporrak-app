/*! oporrak 2023-05-16 */
import axios from"axios";import{serverAPI,puertoAPI}from"../../config/settings";import{tiposMovimiento,estadosUsuario,tiposEstado,tiposRol,arrTiposEstado,arrColoresEstado}from"../../public/js/enumeraciones";const mainPage=async(s,o)=>{var i=s.user,n=s.query.dir||"next",d=s.query.limit||10,r=s.query.part?s.query.part.toUpperCase():"";let p=!!(s=s.query.cursor?JSON.parse(s.query.cursor):null),S={};S=s?{oficina:i.rol===tiposRol.admin?0:i.oficina,limit:d+1,direction:n,cursor:JSON.parse(convertCursorToNode(JSON.stringify(s))),part:r}:{oficina:i.rol===tiposRol.admin?0:i.oficina,limit:d+1,direction:n,cursor:{next:"",prev:""},part:r};try{let r=(await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuarios`,{context:S})).data.data,a=r.length===d+1,e="",t="";a?(e=("next"===n?r[d-1]:r[0]).NOMUSU,t=("next"===n?r[0]:r[d-1]).NOMUSU,r.pop()):(e="next"===n?"":r[0]?.NOMUSU,t="next"===n?r[0]?.NOMUSU:"",p=s?(a=""!==e,""!==t):a=!1),"prev"===n&&(r=r.sort((r,a)=>r.NOMUSU.localeCompare(a.NOMUSU)));var s={next:e,prev:t},u={usuarios:r,hasPrevUsers:p,hasNextUsers:a,cursor:convertNodeToCursor(JSON.stringify(s)),estadosUsuario:estadosUsuario};o.render("admin/calendarios",{user:i,datos:u})}catch(r){400===r.response?.status?o.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):o.render("admin/error500",{alerts:[{msg:r}]})}},calendarioPage=async(r,e)=>{var t=r.user,s=(new Date).getFullYear(),o=dateISOToUTCString(s+"-01-01T00:00:00"),s=dateISOToUTCString(s+1+"-12-31T00:00:00");try{var i=await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuario`,{context:{IDUSUA:r.query.id}}),n=await axios.post(`http://${serverAPI}:${puertoAPI}/api/estados/usuario`,{context:{USUEST:i.data.data[0].IDUSUA,DESDE:o,HASTA:s}}),d=await axios.post(`http://${serverAPI}:${puertoAPI}/api/festivos/oficinas`,{context:{OFIFES:i.data.data[0].OFIUSU,DESDE:o,HASTA:s}});let a=[];n.data.data.map(r=>{r.TIPEST!==tiposEstado.traspasado.ID&&r.TIPEST!==tiposEstado.traspaso.ID&&(r={idesta:r.IDESTA,tipest:r.TIPEST,startDate:r.STRFEC,endDate:r.STRFEC,rangoH:`${arrColoresEstado[r.TIPEST].DES} (${r.DESHOR} a ${r.HASHOR})`,color:""+arrColoresEstado[r.TIPEST].COLOR,deshor:r.DESHOR,hashor:r.HASHOR},a.push(r))});var p={arrTiposEstado:arrTiposEstado,arrColoresEstado:arrColoresEstado,tiposEstado:tiposEstado,estadosUsuario:estadosUsuario,festivos:JSON.stringify(d.data.data),usuario:i.data.data[0],dataSource:JSON.stringify(a)};e.render("admin/calendarios/calendario",{user:t,datos:p})}catch(r){400===r.response?.status?e.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:r}]})}},update=async(r,a)=>{var e=r.user;const t=JSON.parse(r.body.usuario);r=JSON.parse(r.body.eventos);let s=[];r.map(r=>{r.idesta<0?s.push({IDESTA:0,FECEST:r.fecest,USUEST:t.IDUSUA,TIPEST:r.tipest,OFIEST:t.OFIUSU,DESHOR:r.deshor,HASHOR:r.hashor}):s.push({IDESTA:r.idesta,FECEST:"",USUEST:0,TIPEST:0,OFIEST:0,DESHOR:"",HASHOR:""})});r={ARREST:s},e={USUMOV:e.id,TIPMOV:tiposMovimiento.crearEstado,TIPMOZ:tiposMovimiento.borrarEstado};try{0!==s.length&&await axios.post(`http://${serverAPI}:${puertoAPI}/api/estados/update`,{context:r,movimiento:e}),a.redirect("/admin/calendarios")}catch(r){400===r.response?.status?a.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):a.render("admin/error500",{alerts:[{msg:r}]})}},dateISOToUTCString=r=>{var r=new Date(r),a=6e4*r.getTimezoneOffset();return new Date(r.getTime()-a).toISOString().slice(0,10)},convertNodeToCursor=r=>new Buffer.from(r,"binary").toString("base64"),convertCursorToNode=r=>new Buffer.from(r,"base64").toString("binary");export{mainPage,calendarioPage,update};