/*! oporrak 2023-05-17 */
import axios from"axios";import{serverAPI,puertoAPI}from"../../config/settings";import{arrTiposRol,arrTiposPerfil,arrEstadosUsuario,estadosUsuario,tiposMovimiento,tiposRol}from"../../public/js/enumeraciones";const mainPage=async(o,t)=>{var i=o.user,u=o.query.dir||"next",d=o.query.limit||10,r=o.query.part?o.query.part.toUpperCase():"";let n=!!(o=o.query.cursor?JSON.parse(o.query.cursor):null),p={};p=o?{oficina:i.rol===tiposRol.admin?0:i.oficina,limit:d+1,direction:u,cursor:JSON.parse(convertCursorToNode(JSON.stringify(o))),part:r}:{oficina:i.rol===tiposRol.admin?0:i.oficina,limit:d+1,direction:u,cursor:{next:"",prev:""},part:r};try{let r=(await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuarios`,{context:p})).data.data,s=r.length===d+1,e="",a="";s?(e=("next"===u?r[d-1]:r[0]).NOMUSU,a=("next"===u?r[0]:r[d-1]).NOMUSU,r.pop()):(e="next"===u?"":r[0]?.NOMUSU,a="next"===u?r[0]?.NOMUSU:"",n=o?(s=""!==e,""!==a):s=!1),"prev"===u&&(r=r.sort((r,s)=>r.NOMUSU>s.NOMUSU?1:-1));var o={next:e,prev:a},m={usuarios:r,hasPrevUsers:n,hasNextUsers:s,cursor:convertNodeToCursor(JSON.stringify(o)),estadosUsuario:estadosUsuario};t.render("admin/usuarios",{user:i,datos:m})}catch(r){400===r.response?.status?t.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):t.render("admin/error500",{alerts:[{msg:r}]})}},addPage=async(r,s)=>{const e=r.user;r=arrTiposRol.filter(r=>r.id<=e.rol);try{var a={oficinas:(await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficina`,{context:{}})).data.data,filteredRol:r,arrTiposPerfil:arrTiposPerfil,arrEstadosUsuario:arrEstadosUsuario};s.render("admin/usuarios/add",{user:e,datos:a})}catch(r){400===r.response?.status?s.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):s.render("admin/error500",{alerts:[{msg:r}]})}},editPage=async(r,s)=>{const e=r.user;var a=arrTiposRol.filter(r=>r.id<=e.rol);try{var o=await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficina`,{context:{}}),t={usuario:(await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuario`,{context:{IDUSUA:r.params.id}})).data.data[0],oficinas:o.data.data,filteredRol:a,arrTiposPerfil:arrTiposPerfil,arrEstadosUsuario:arrEstadosUsuario};s.render("admin/usuarios/edit",{user:e,datos:t})}catch(r){400===r.response?.status?s.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):s.render("admin/error500",{alerts:[{msg:r}]})}},insert=async(r,s)=>{var e=r.user;try{var a={NOMUSU:r.body.nomusu.toUpperCase(),OFIUSU:r.body.ofiusu,ROLUSU:r.body.rolusu,USERID:r.body.userid.toLowerCase(),EMAUSU:r.body.emausu,PERUSU:r.body.perusu,TELUSU:r.body.telusu,STAUSU:r.body.stausu},o={USUMOV:e.id,TIPMOV:tiposMovimiento.crearUsuario};await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuarios/insert`,{usuario:a,recurso:recurso,movimiento:o}),s.redirect("/admin/usuarios?part="+r.query.part)}catch(r){400===r.response?.status?s.render("admin/error400",{alerts:[{msg:r.response.data.data}]}):s.render("admin/error500",{alerts:[{msg:r}]})}},update=async(r,s)=>{var e=r.user,a={IDUSUA:r.body.idusua,NOMUSU:r.body.nomusu.toUpperCase(),OFIUSU:r.body.ofiusu,ROLUSU:r.body.rolusu,EMAUSU:r.body.emausu,PERUSU:r.body.perusu,TELUSU:r.body.telusu,STAUSU:r.body.stausu},e={USUMOV:e.id,TIPMOV:tiposMovimiento.modificarUsuario};try{await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuarios/update`,{usuario:a,movimiento:e}),s.redirect("/admin/usuarios?part="+r.query.part)}catch(r){400===r.response?.status?s.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):s.render("admin/error500",{alerts:[{msg:r}]})}},remove=async(r,s)=>{var e=r.user,a={IDUSUA:r.body.idusua},e={USUMOV:e.id,TIPMOV:tiposMovimiento.borrarUsuario};try{await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuarios/delete`,{usuario:a,movimiento:e}),s.redirect("/admin/usuarios?part="+r.query.part)}catch(r){400===r.response?.status?s.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):s.render("admin/error500",{alerts:[{msg:r}]})}},convertNodeToCursor=r=>new Buffer.from(r,"binary").toString("base64"),convertCursorToNode=r=>new Buffer.from(r,"base64").toString("binary");export{mainPage,addPage,editPage,insert,update,remove};