/*! oporrak 2023-05-17 */
import axios from"axios";import{puertoAPI,serverAPI}from"../../config/settings";import{tiposEstado,tiposMovimiento}from"../../public/js/enumeraciones";const mainPage=async(s,o)=>{var i=s.user,n=s.query.dir||"next",d=s.query.limit||10,e=s.query.part?s.query.part.toUpperCase():"";let p=!!(s=s.query.cursor?JSON.parse(s.query.cursor):null),c={};c=s?{limit:d+1,direction:n,cursor:JSON.parse(convertCursorToNode(JSON.stringify(s))),part:e}:{limit:d+1,direction:n,cursor:{next:0,prev:0},part:e};try{let e=(await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficinas`,{context:c})).data.data,r=e.length===d+1,t=0,a=0;r?(t=("next"===n?e[d-1]:e[0]).IDOFIC,a=("next"===n?e[0]:e[d-1]).IDOFIC,e.pop()):(t="next"===n?0:e[0]?.IDOFIC,a="next"===n?e[0]?.IDOFIC:0,p=s?(r=0!==t,0!==a):r=!1),"prev"===n&&(e=e.reverse());var s={next:t,prev:a},m={oficinas:e,hasNextOficinas:r,hasPrevOficinas:p,cursor:convertNodeToCursor(JSON.stringify(s))};o.render("admin/festivos",{user:i,datos:m})}catch(e){400===e.response?.status?o.render("admin/error400",{alerts:[{msg:e.response.data.msg}]}):o.render("admin/error500",{alerts:[{msg:e}]})}},calendarioPage=async(r,t)=>{var a=r.user,s=(new Date).getFullYear();let o={IDOFIC:0,DESOFI:"FESTIVOS COMUNES",CODOFI:"000"};try{"0"!==r.params.id&&(i=await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficina`,{context:{IDOFIC:r.params.id}}),o=i.data.data[0]);var i,n=await axios.post(`http://${serverAPI}:${puertoAPI}/api/festivos/locales/oficinas`,{context:{OFIFES:r.params.id,DESDE:dateISOToUTCString(s+"-01-01T00:00:00"),HASTA:dateISOToUTCString(s+1+"-12-31T00:00:00")}});let e=[];n.data.stat&&(e=n.data.data.map(e=>({idfest:e.IDFEST,fecfes:e.FECFES,ofifes:e.OFIFES,startDate:e.FECFES,endDate:e.FECFES,color:tiposEstado.festivo.COLOR})));var d={oficina:o,dataSource:JSON.stringify(e),tiposEstado:tiposEstado};t.render("admin/festivos/calendario",{user:a,datos:d})}catch(e){400===e.response?.status?t.render("admin/error400",{alerts:[{msg:e.response.data.msg}]}):t.render("admin/error500",{alerts:[{msg:e}]})}},update=async(e,r)=>{var t=e.user,a=JSON.parse(e.body.eventos);let s=[];a.map(e=>{e.idfest<0?s.push({IDFEST:0,FECFES:e.fecfes,OFIFES:e.ofifes}):s.push({IDFEST:e.idfest,FECEST:"",OFIEST:0})});a={ARRFES:s},t={USUMOV:t.id,TIPMOV:tiposMovimiento.crearEstado,TIPMOZ:tiposMovimiento.borrarEstado};try{0!==s.length&&await axios.post(`http://${serverAPI}:${puertoAPI}/api/festivos/update`,{context:a,movimiento:t}),r.redirect("/admin/festivos?part="+e.query.part)}catch(e){400===e.response?.status?r.render("admin/error400",{alerts:[{msg:e.response.data.msg}]}):r.render("admin/error500",{alerts:[{msg:e}]})}},dateISOToUTCString=e=>{var e=new Date(e),r=6e4*e.getTimezoneOffset();return new Date(e.getTime()-r).toISOString().slice(0,10)},convertNodeToCursor=e=>new Buffer.from(e,"binary").toString("base64"),convertCursorToNode=e=>new Buffer.from(e,"base64").toString("binary");export{mainPage,calendarioPage,update};