/*! oporrak 2023-05-13 */
import axios from"axios";import{serverAPI,puertoAPI}from"../../config/settings";import{estadosUsuario,tiposEstado,tiposMovimiento}from"../../public/js/enumeraciones";const mainPage=async(o,i)=>{var d=o.user,n=o.query.dir||"next",p=o.query.limit||10,a=o.query.part?o.query.part.toUpperCase():"";let u=!!(o=o.query.cursor?JSON.parse(o.query.cursor):null),S={};S=o?{limit:p+1,direction:n,cursor:JSON.parse(convertCursorToNode(JSON.stringify(o))),part:a}:{limit:p+1,direction:n,cursor:{next:"",prev:""},part:a};try{var T=await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficina`,{context:{}});let a=(await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuarios`,{context:S})).data.data,t=a.length===p+1,e="",s="",r=void 0;t?(r=[{msg:"Se supera el límite de registros permitidos. Sólo se muestran 99 registros. Refine la consulta"}],e=("next"===n?a[p-1]:a[0]).NOMUSU,s=("next"===n?a[0]:a[p-1]).NOMUSU,a.pop()):(e="next"===n?"":a[0]?.NOMUSU,s="next"===n?a[0]?.NOMUSU:"",u=o?(t=""!==e,""!==s):t=!1),"prev"===n&&(a=a.sort((a,t)=>a.NOMUSU.localeCompare(t.NOMUSU)));var o={next:e,prev:s},c={oficinas:T.data.data,usuarios:a,hasPrevUsers:u,hasNextUsers:t,cursor:convertNodeToCursor(JSON.stringify(o)),estadosUsuario:estadosUsuario};i.render("admin/traspasos",{user:d,alerts:r,datos:c})}catch(a){400===a.response?.status?i.render("admin/error400",{alerts:[{msg:a.response.data.msg}]}):i.render("admin/error500",{alerts:[{msg:a}]})}},calendarioPage=async(a,t)=>{var s=a.user,r=(new Date).getFullYear(),r={DESDE:dateISOToUTCString(r+"-01-01T00:00:00"),HASTA:dateISOToUTCString(r+1+"-12-31T00:00:00")};try{var o=await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuario`,{context:{IDUSUA:a.params.id}}),i=await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficina`,{context:{}}),d=await axios.post(`http://${serverAPI}:${puertoAPI}/api/festivos`,{context:{DESDE:r.DESDE,HASTA:r.HASTA}});const S=await axios.post(`http://${serverAPI}:${puertoAPI}/api/estados/usuario`,{context:{USUEST:a.params.id,DESDE:r.DESDE,HASTA:r.HASTA}});var n=d.data.data.filter(a=>0===a.OFIFES),p=d.data.data.filter(a=>0<a.OFIFES);let e=[];S.data.data.map(a=>{var t;a.TIPEST===tiposEstado.traspaso.ID&&(a.TIPEST=tiposEstado.traspasado.ID,t=S.data.data[S.data.data.indexOf(a)],a={idesta:a.IDESTA,ofiest:t.OFIEST,startDate:t.STRFEC,endDate:t.STRFEC,rangoH:`${t.DESOFI}\n(${t.DESHOR} a ${t.HASHOR})`,color:""+tiposEstado.traspaso.COLOR},e.push(a))});var u={oficinas:i.data.data,festivosComun:n,festivosLocal:p,tiposEstado:tiposEstado,usuario:o.data.data[0],dataSource:JSON.stringify(e)};t.render("admin/traspasos/calendario",{user:s,datos:u})}catch(a){400===a.response?.status?t.render("admin/error400",{alerts:[{msg:a.response.data.msg}]}):t.render("admin/error500",{alerts:[{msg:a}]})}},update=async(t,e)=>{var a=t.user,s=JSON.parse(t.body.eventos);let r=[];s.map(a=>{0===a.idesta?(r.push({IDESTA:a.idesta,FECEST:a.fecest,USUEST:t.body.idusua,TIPEST:tiposEstado.traspaso.ID,OFIEST:t.body.ofiusu}),r.push({IDESTA:a.idesta,FECEST:a.fecest,USUEST:t.body.idusua,TIPEST:tiposEstado.traspasado.ID,OFIEST:a.ofiest})):r.push({IDESTA:a.idesta,FECEST:a.fecest,USUEST:t.body.idusua,TIPEST:tiposEstado.traspasado.ID,OFIEST:0})});s={ARRTRA:r},a={USUMOV:a.id,TIPMOV:tiposMovimiento.crearTraspaso,TIPMOZ:tiposMovimiento.borrarTraspaso};try{0!==r.length&&await axios.post(`http://${serverAPI}:${puertoAPI}/api/estados/update/traspasos`,{context:s,movimiento:a}),e.redirect("/admin/traspasos")}catch(a){400===a.response?.status?e.render("admin/error400",{alerts:[{msg:a.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:a}]})}},dateISOToUTCString=a=>{var a=new Date(a),t=6e4*a.getTimezoneOffset();return new Date(a.getTime()-t).toISOString().slice(0,10)},convertNodeToCursor=a=>new Buffer.from(a,"binary").toString("base64"),convertCursorToNode=a=>new Buffer.from(a,"base64").toString("binary");export{mainPage,calendarioPage,update};