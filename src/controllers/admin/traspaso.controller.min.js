/*! oporrak 2023-05-18 */
import axios from"axios";import{serverAPI,puertoAPI}from"../../config/settings";import{estadosUsuario,tiposEstado,tiposMovimiento}from"../../public/js/enumeraciones";const mainPage=async(o,i)=>{var n=o.user,p=o.query.dir||"next",d=o.query.limit||10,a=o.query.part?o.query.part.toUpperCase():"";let u=!!(o=o.query.cursor?JSON.parse(o.query.cursor):null),S={};S=o?{limit:d+1,direction:p,cursor:JSON.parse(convertCursorToNode(JSON.stringify(o))),part:a}:{limit:d+1,direction:p,cursor:{next:"",prev:""},part:a};try{var m=await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficina`,{context:{}});let a=(await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuarios`,{context:S})).data.data,t=a.length===d+1,e="",r="",s=void 0;t?(s=[{msg:"Se supera el límite de registros permitidos. Sólo se muestran 99 registros. Refine la consulta"}],e=("next"===p?a[d-1]:a[0]).NOMUSU,r=("next"===p?a[0]:a[d-1]).NOMUSU,a.pop()):(e="next"===p?"":a[0]?.NOMUSU,r="next"===p?a[0]?.NOMUSU:"",u=o?(t=""!==e,""!==r):t=!1),"prev"===p&&(a=a.sort((a,t)=>a.NOMUSU.localeCompare(t.NOMUSU)));var o={next:e,prev:r},c={oficinas:m.data.data,usuarios:a,hasPrevUsers:u,hasNextUsers:t,cursor:convertNodeToCursor(JSON.stringify(o)),estadosUsuario:estadosUsuario};i.render("admin/traspasos",{user:n,alerts:s,datos:c})}catch(a){400===a.response?.status?i.render("admin/error400",{alerts:[{msg:a.response.data.msg}]}):i.render("admin/error500",{alerts:[{msg:a}]})}},calendarioPage=async(a,e)=>{var r=a.user,s=(new Date).getFullYear(),s={DESDE:dateISOToUTCString(s+"-01-01T00:00:00"),HASTA:dateISOToUTCString(s+1+"-12-31T00:00:00")};try{var o=await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuario`,{context:{IDUSUA:a.params.id}}),i=await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficina`,{context:{}}),n=await axios.post(`http://${serverAPI}:${puertoAPI}/api/festivos`,{context:{DESDE:s.DESDE,HASTA:s.HASTA}}),p=await axios.post(`http://${serverAPI}:${puertoAPI}/api/estados/usuario`,{context:{TIPEST:tiposEstado.traspasado.ID,USUEST:a.params.id,DESDE:s.DESDE,HASTA:s.HASTA}}),d=n.data.data.filter(a=>0===a.OFIFES).map(a=>a.FECFES),u=n.data.data.filter(a=>0<a.OFIFES);let t=[];p.data.data.map(a=>{a={idesta:a.IDESTA,ofiest:a.OFIEST,startDate:a.STRFEC,endDate:a.STRFEC,rangoH:`${a.DESOFI}\n(${a.DESHOR} a ${a.HASHOR})`,color:""+tiposEstado.traspaso.COLOR};t.push(a)});var S={oficinas:i.data.data,festivosComun:d,festivosLocal:u,tiposEstado:tiposEstado,usuario:o.data.data[0],dataSource:JSON.stringify(t)};e.render("admin/traspasos/calendario",{user:r,datos:S})}catch(a){400===a.response?.status?e.render("admin/error400",{alerts:[{msg:a.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:a}]})}},update=async(t,e)=>{var a=t.user,r=JSON.parse(t.body.eventos);let s=[];r.map(a=>{0===a.idesta?(s.push({IDESTA:a.idesta,FECEST:a.fecest,USUEST:t.body.idusua,TIPEST:tiposEstado.traspaso.ID,OFIEST:t.body.ofiusu}),s.push({IDESTA:a.idesta,FECEST:a.fecest,USUEST:t.body.idusua,TIPEST:tiposEstado.traspasado.ID,OFIEST:a.ofiest})):s.push({IDESTA:a.idesta,FECEST:a.fecest,USUEST:t.body.idusua,TIPEST:tiposEstado.traspasado.ID,OFIEST:0})});r={ARRTRA:s},a={USUMOV:a.id,TIPMOV:tiposMovimiento.crearTraspaso,TIPMOZ:tiposMovimiento.borrarTraspaso};try{0!==s.length&&await axios.post(`http://${serverAPI}:${puertoAPI}/api/estados/update/traspasos`,{context:r,movimiento:a}),e.redirect("/admin/traspasos?part="+t.query.part)}catch(a){400===a.response?.status?e.render("admin/error400",{alerts:[{msg:a.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:a}]})}},dateISOToUTCString=a=>{var a=new Date(a),t=6e4*a.getTimezoneOffset();return new Date(a.getTime()-t).toISOString().slice(0,10)},convertNodeToCursor=a=>new Buffer.from(a,"binary").toString("base64"),convertCursorToNode=a=>new Buffer.from(a,"base64").toString("binary");export{mainPage,calendarioPage,update};