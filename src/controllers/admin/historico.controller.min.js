/*! oporrak 2023-05-13 */
import axios from"axios";import{serverAPI,puertoAPI}from"../../config/settings";import{tiposMovimiento,arrTiposRol,arrTiposPerfil}from"../../public/js/enumeraciones";const mainPage=async(o,a)=>{var i=o.user,n=o.query.dir||"next",d=o.query.limit||10,r=o.query.part?o.query.part.toUpperCase():"";let u=!!(o=o.query.cursor?JSON.parse(o.query.cursor):null),p={};p=o?{limit:d+1,direction:n,cursor:JSON.parse(convertCursorToNode(JSON.stringify(o))),part:r}:{limit:d+1,direction:n,cursor:{next:"",prev:""},part:r};try{let r=(await axios.post(`http://${serverAPI}:${puertoAPI}/api/historicos`,{context:p})).data.data,e=r.length===d+1,t="",s="";e?(t=("next"===n?r[d-1]:r[0]).NOMUSU,s=("next"===n?r[0]:r[d-1]).NOMUSU,r.pop()):(t="next"===n?"":r[0]?.NOMUSU,s="next"===n?r[0]?.NOMUSU:"",u=o?(e=""!==t,""!==s):e=!1),"prev"===n&&(r=r.sort((r,e)=>r.NOMUSU>e.NOMUSU?1:-1));var o={next:t,prev:s},c={usuarios:r,hasNextUsers:e,hasPrevUsers:u,cursor:convertNodeToCursor(JSON.stringify(o))};a.render("admin/historicos",{user:i,datos:c})}catch(r){400===r.response?.status?a.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):a.render("admin/error500",{alerts:[{msg:r}]})}},editPage=async(r,e)=>{const t=r.user;var s=arrTiposRol.filter(r=>r.id<=t.rol);try{var o=await axios.post(`http://${serverAPI}:${puertoAPI}/api/oficina`,{context:{}}),a={usuario:(await axios.post(`http://${serverAPI}:${puertoAPI}/api/historico`,{context:{IDUSUA:r.params.id}})).data.data[0],oficinas:o.data.data,filteredRol:s,arrTiposPerfil:arrTiposPerfil};e.render("admin/historicos/edit",{user:t,datos:a})}catch(r){400===r.response?.status?e.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:r}]})}},update=async(r,e)=>{var t=r.user,s={IDUSUA:r.body.idusua,NOMUSU:r.body.nomusu,OFIUSU:r.body.ofiusu,ROLUSU:r.body.rolusu,EMAUSU:r.body.emausu,PERUSU:r.body.perusu,TELUSU:r.body.telusu},t={USUMOV:t.id,TIPMOV:tiposMovimiento.modificarHistorico};try{await axios.post(`http://${serverAPI}:${puertoAPI}/api/historicos/update`,{usuario:s,movimiento:t}),e.redirect("/admin/historicos?part="+r.query.part)}catch(r){400===r.response?.status?e.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:r}]})}},activar=async(r,e)=>{var t=r.user;try{var s={IDUSUA:r.body.idusua},o={USUMOV:t.id,TIPMOV:tiposMovimiento.activarHistorico};await axios.post(`http://${serverAPI}:${puertoAPI}/api/historicos/activar`,{usuario:s,movimiento:o}),e.redirect("/admin/historicos?part="+r.query.part)}catch(r){400===r.response?.status?e.render("admin/error400",{alerts:[{msg:r.response.data.msg}]}):e.render("admin/error500",{alerts:[{msg:r}]})}},convertNodeToCursor=r=>new Buffer.from(r,"binary").toString("base64"),convertCursorToNode=r=>new Buffer.from(r,"base64").toString("binary");export{mainPage,editPage,update,activar};