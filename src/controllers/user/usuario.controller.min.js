/*! oporrak 2023-05-18 */
import axios from"axios";import{puertoAPI,serverAPI,serverWEB,puertoWEB,serverAUTH,puertoAUTH}from"../../config/settings";import{tiposMovimiento,tiposEstado,estadosMatricula}from"../../public/js/enumeraciones";const mainPage=async(e,a)=>{e=e.user;try{var o=await axios.post(`http://${serverAPI}:${puertoAPI}/api/estados/usuarios/tipo`,{context:{FECEST:dateISOToUTCString(new Date),TIPEST:tiposEstado.telefono.ID}}),i=!!(await axios.post(`http://${serverAPI}:${puertoAPI}/api/formacion/matricula`,{context:{IDUSUA:e.id,STAMAT:estadosMatricula.abierta}})).data.stat;let t="",r=[];o.data.data.map(e=>{var a;2===e.TIPEST&&((a=(new Date).toTimeString().slice(0,5))>=e.DESHOR&&a<=e.HASHOR||(e.TIPEST=1),e.USERID===t&&(1===e.TIPEST&&(e=r.slice(-1)[0]),r.splice(-1)),t=e.USERID),r.push(e)});var s={estados:r,hayMatricula:i};a.render("user",{user:e,datos:s})}catch(e){a.render("user/error400",{alerts:[{msg:"No se ha podido acceder a los datos de la aplicación."}]})}},perfilPage=async(e,a)=>{e=e.user;try{var t={usuario:(await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuario`,{context:{USERID:e.userid}})).data.data[0]};a.render("user/perfil",{user:e,datos:t})}catch(e){a.render("user/error400",{alerts:[{msg:"No se ha podido acceder a los datos de la aplicación."}]})}},logoutPage=async(e,a)=>{var t={path:"/",sameSite:!0,maxAge:1,httpOnly:!0};a.clearCookie("x-access_token"),a.cookie("auth",void 0,t),a.cookie("verPan",void 0,t),a.cookie("filtro",void 0,t),a.redirect("/")},updatePerfil=async(e,a)=>{var t=e.user,e={IDUSUA:t.id,USERID:t.userid,NOMUSU:e.body.nomusu.toUpperCase(),EMAUSU:e.body.emausu,TELUSU:e.body.telusu},t={USUMOV:t.id,TIPMOV:tiposMovimiento.modificarPerfil};try{await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuarios/perfil`,{usuario:e,movimiento:t}),a.redirect("/user")}catch(e){a.redirect("/")}},changePassword=async(e,a)=>{var t=encodeURIComponent(serverWEB+":"+puertoWEB),r={path:"/",sameSite:!0,maxAge:1,httpOnly:!0};a.clearCookie("x-access_token"),a.cookie("auth",void 0,r),a.cookie("noVer",void 0,r),a.redirect(`http://${serverAUTH}:${puertoAUTH}/log/change/?valid=`+t)},dateISOToUTCString=e=>{var e=new Date(e),a=6e4*e.getTimezoneOffset();return new Date(e.getTime()-a).toISOString().slice(0,10)};export{mainPage,perfilPage,logoutPage,updatePerfil,changePassword};