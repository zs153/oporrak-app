/*! oporrak 2023-05-17 */
import axios from"axios";import{serverAPI,puertoAPI}from"../../config/settings";import{tiposMovimiento,estadosUsuario,tiposEstado,arrTiposEstadoUsuario,arrColoresEstado}from"../../public/js/enumeraciones";const mainPage=async(r,s)=>{var r=r.user,a=(new Date).getFullYear();try{var e=await axios.post(`http://${serverAPI}:${puertoAPI}/api/usuarios/stats`,{context:{IDUSUA:r.id,DESDE:dateISOToUTCString(a+"-01-01T00:00:00"),HASTA:dateISOToUTCString(a+1+"-12-31T00:00:00")}}),t={estadosUsuario:estadosUsuario,usuario:e.data.data[0]};s.render("user/calendarios",{user:r,datos:t})}catch(r){400===r.response?.status?s.render("user/error400",{alerts:[{msg:r.response.data.msg}]}):s.render("user/error500",{alerts:[{msg:r}]})}},calendarioPage=async(r,a)=>{var e=r.user,t=(new Date).getFullYear(),r=JSON.parse(r.body.usuario),o=dateISOToUTCString(t+"-01-01T00:00:00"),t=dateISOToUTCString(t+1+"-12-31T00:00:00");try{var i=await axios.post(`http://${serverAPI}:${puertoAPI}/api/estados/usuario`,{context:{USUEST:r.IDUSUA,DESDE:o,HASTA:t}}),d=await axios.post(`http://${serverAPI}:${puertoAPI}/api/festivos/oficinas`,{context:{OFIFES:r.OFIUSU,DESDE:o,HASTA:t}});let s=[];i.data.data.map(r=>{r.TIPEST!==tiposEstado.traspasado.ID&&r.TIPEST!==tiposEstado.traspaso.ID&&(r={idesta:r.IDESTA,tipest:r.TIPEST,startDate:r.STRFEC,endDate:r.STRFEC,rangoH:`${arrColoresEstado[r.TIPEST].DES} (${r.DESHOR} a ${r.HASHOR})`,color:""+arrColoresEstado[r.TIPEST].COLOR,deshor:r.DESHOR,hashor:r.HASHOR},s.push(r))});var S={arrTiposEstado:arrTiposEstadoUsuario,arrColoresEstado:arrColoresEstado,tiposEstado:tiposEstado,festivos:JSON.stringify(d.data.data),usuario:r,dataSource:JSON.stringify(s)};a.render("user/calendarios/calendario",{user:e,datos:S})}catch(r){400===r.response?.status?a.render("user/error400",{alerts:[{msg:r.response.data.msg}]}):a.render("user/error500",{alerts:[{msg:r}]})}},update=async(r,s)=>{var a=r.user;const e=JSON.parse(r.body.usuario);r=JSON.parse(r.body.eventos);let t=[];r.map(r=>{r.idesta<0?t.push({IDESTA:0,FECEST:r.fecest,USUEST:e.IDUSUA,TIPEST:r.tipest,OFIEST:e.OFIUSU,DESHOR:r.deshor,HASHOR:r.hashor}):t.push({IDESTA:r.idesta,FECEST:"",USUEST:0,TIPEST:0,OFIEST:0,DESHOR:"",HASHOR:""})});r={ARREST:t},a={USUMOV:a.id,TIPMOV:tiposMovimiento.crearEstado,TIPMOZ:tiposMovimiento.borrarEstado};try{0!==t.length&&await axios.post(`http://${serverAPI}:${puertoAPI}/api/estados/update`,{context:r,movimiento:a}),s.redirect("/user/calendario")}catch(r){400===r.response?.status?s.render("user/error400",{alerts:[{msg:r.response.data.msg}]}):s.render("user/error500",{alerts:[{msg:r}]})}},dateISOToUTCString=r=>{var r=new Date(r),s=6e4*r.getTimezoneOffset();return new Date(r.getTime()-s).toISOString().slice(0,10)};export{mainPage,calendarioPage,update};