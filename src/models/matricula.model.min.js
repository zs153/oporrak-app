/*! oporrak 2023-05-14 */
import{BIND_OUT,NUMBER}from"oracledb";import{simpleExecute}from"../services/database.js";const baseSql=`SELECT 
  mm.idmatr,
  mm.desmat,
  mm.idcurs,
  mm.stamat,
  TO_CHAR(mm.inimat, 'DD/MM/YYYY') AS STRINI,
  TO_CHAR(mm.finmat, 'DD/MM/YYYY') AS STRFIN
FROM matriculas mm
INNER JOIN matriculascurso mc ON mc.idmatr = mm.idmatr
`,insertSql=`BEGIN OPORRAK_PKG.INSERTMATRICULA(
  :desmat,
  TO_DATE(:inimat, 'YYYY-MM-DD'),
  TO_DATE(:finmat, 'YYYY-MM-DD'),
  :notmat,
  :stamat,
  :usumov,
  :tipmov,
  :idmatr
); END;
`,updateSql=`BEGIN OPORRAK_PKG.UPDATEMATRICULA(
  :idmatr,
  :desmat,
  TO_DATE(:inimat, 'YYYY-MM-DD'),
  TO_DATE(:finmat, 'YYYY-MM-DD'),
  :notmat,
  :stamat,
  :usumov,
  :tipmov
); END;
`,removeSql=`BEGIN OPORRAK_PKG.DELETEMATRICULA(
  :idmatr,
  :usumov,
  :tipmov 
); END;
`,usuariosMatriculaSql=`SELECT 
  uu.idusua,
  uu.nomusu,
  uu.userid,
  oo.desofi
FROM usuarios uu
INNER JOIN usuariosmatricula um ON um.idusua = uu.idusua
INNER JOIN oficinas oo ON oo.idofic = uu.ofiusu
`,usuariosPendientesSql=`SELECT 
  uu.idusua, uu.nomusu, oo.desofi FROM usuarios uu
LEFT JOIN usuariosmatricula um ON uu.idusua = um.idusua AND
  um.idmatr= :idmatr
INNER JOIN oficinas oo ON oo.idofic = uu.ofiusu
WHERE um.idusua IS NULL AND 
  uu.stausu = 1
ORDER BY oo.idofic, uu.nomusu
`,insertUsuarioSql=`BEGIN OPORRAK_PKG.INSERTUSUARIOMATRICULA(
  :idmatr,
  :arrusu,
  :usumov,
  :tipmov
); END;
`,removeUsuarioSql=`BEGIN OPORRAK_PKG.DELETEUSUARIOMATRICULA(
  :idmatr,
  :idusua,
  :usumov,
  :tipmov
); END;
`,find=async a=>{let t=baseSql;a.IDMATR&&(t+="WHERE mm.idmatr = :idmatr");a=await simpleExecute(t,a);return a?{stat:a.rows.length,data:a.rows}:{stat:0,data:[]}},insert=async a=>{a.IDMATR={dir:BIND_OUT,type:NUMBER};var t=await simpleExecute(insertSql,a);return t?(a.IDMATR=t.outBinds.IDMATR,{stat:1,data:a}):{stat:0,data:[]}},update=async a=>{return await simpleExecute(updateSql,a)?{stat:1,data:a}:{stat:0,data:[]}},remove=async a=>{return await simpleExecute(removeSql,a)?{stat:1,data:a}:{stat:0,data:[]}},usuariosMatricula=async a=>{var t=usuariosMatriculaSql,t=await simpleExecute(t,a);return t?{stat:t.rows.length,data:t.rows}:{stat:0,data:[]}},usuariosPendientes=async a=>{let t=usuariosPendientesSql;a.IDMATR&&(t+="WHERE um.idmatr = :idmatr");a=await simpleExecute(t,a);return a?{stat:a.rows.length,data:a.rows}:{stat:0,data:[]}},insertUsuario=async a=>{return await simpleExecute(insertUsuarioSql,a)?{stat:1,data:a}:{stat:null,data:err}},removeUsuario=async a=>{return await simpleExecute(removeUsuarioSql,a)?{stat:1,data:a}:{stat:null,data:[]}};export{find,insert,update,remove,usuariosMatricula,usuariosPendientes,insertUsuario,removeUsuario};