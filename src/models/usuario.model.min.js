/*! oporrak 2023-05-17 */
import{BIND_OUT,NUMBER}from"oracledb";import{simpleExecute}from"../services/database.js";const baseQuery=`SELECT 
    uu.*,
    oo.desofi
  FROM usuarios uu
  INNER JOIN oficinas oo ON oo.idofic = uu.ofiusu
`,estadosSql=`WITH datos AS (
  SELECT uu.idusua,
    SUM(CASE WHEN ee.tipest = 2 THEN 1 ELSE 0 END) "VACAS",
    SUM(CASE WHEN ee.tipest = 5 THEN EXTRACT(DAY FROM (hashor-deshor)*24*60) ELSE 0 END) "F",
    SUM(CASE WHEN ee.tipest = 6 THEN EXTRACT(DAY FROM (hashor-deshor)*24*60) ELSE 0 END) "C",
    SUM(CASE WHEN ee.tipest = 8 THEN EXTRACT(DAY FROM (hashor-deshor)*24*60) ELSE 0 END) "H",
    SUM(CASE WHEN ee.tipest = 9 THEN EXTRACT(DAY FROM (hashor-deshor)*24*60) ELSE 0 END) "T"
  FROM usuarios uu
  LEFT JOIN estados ee ON ee.usuest = uu.idusua
  WHERE uu.idusua = :idusua 
  AND ee.fecest BETWEEN TO_DATE(:desde, 'YYYY-MM-DD') AND TO_DATE(:hasta, 'YYYY-MM-DD')
  GROUP BY uu.idusua
)
SELECT uu.idusua,uu.nomusu,uu.userid,uu.ofiusu,uu.telusu,uu.stausu,oo.desofi,
  CASE WHEN dd.vacas IS NULL THEN 0 ELSE dd.vacas END "VACAS",
  CASE WHEN dd.f IS NULL THEN '000:00' ELSE TO_CHAR(TRUNC(dd.f/60), '099') || ':' || TO_CHAR(mod(dd.f, 60), '09') END "FORMA",
  CASE WHEN dd.c IS NULL THEN '000:00' ELSE TO_CHAR(TRUNC(dd.c/60), '099') || ':' || TO_CHAR(mod(dd.c, 60), '09') END "CONCI",
  CASE WHEN dd.h IS NULL THEN '000:00' ELSE TO_CHAR(TRUNC(dd.h/60), '099') || ':' || TO_CHAR(mod(dd.h, 60), '09') END "HORAS",
  CASE WHEN dd.t IS NULL THEN '000:00' ELSE TO_CHAR(TRUNC(dd.t/60), '099') || ':' || TO_CHAR(mod(dd.t, 60), '09') END "TELEF"
FROM usuarios uu
INNER JOIN oficinas oo ON oo.idofic = uu.ofiusu
LEFT JOIN datos dd ON dd.idusua = uu.idusua
WHERE uu.idusua = :idusua
`,insertSql=`BEGIN OPORRAK_PKG.INSERTUSUARIO(
    :nomusu,
    :ofiusu,
    :rolusu,
    :userid,
    :emausu,
    :perusu,
    :telusu,
    :stausu,
    :usumov,
    :tipmov,
    :idusua
  ); END;
`,updateSql=`BEGIN OPORRAK_PKG.UPDATEUSUARIO(
    :idusua,
    :nomusu, 
    :ofiusu, 
    :rolusu, 
    :emausu, 
    :perusu, 
    :telusu, 
    :stausu, 
    :usumov, 
    :tipmov
  ); END;
`,removeSql=`BEGIN OPORRAK_PKG.DELETEUSUARIO(
  :idusua,
  :usumov,
  :tipmov
); END;
`,cambioSql=`BEGIN OPORRAK_PKG.CHANGEPASSWORD(
  :idusua,
  :pwdusu,
  :usumov,
  :tipmov
); END;
`,olvidoSql=`BEGIN OPORRAK_PKG.FORGOTPASSWORD(
  :emausu,
  :pwdusu, 
  :tipmov,
  :saltus
); END;
`,perfilSql=`BEGIN OPORRAK_PKG.UPDATEPERFILUSUARIO(
  :idusua,
  :nomusu,
  :emausu,
  :telusu, 
  :usumov,
  :tipmov
); END;
`,find=async u=>{let s=baseQuery;u.IDUSUA?s+="WHERE uu.idusua = :idusua":u.USERID?s+="WHERE uu.userid = :userid":u.EMAUSU?s+="WHERE uu.emausu = :emausu":u.OFIUSU&&(s+="WHERE uu.ofiusu = :ofiusu");u=await simpleExecute(s,u);return u?{stat:u.rows.length,data:u.rows}:{stat:0,data:[]}},findAll=async u=>{let s="";var a={limit:u.limit,part:u.part},u=(s=u.oficina?(a.ofiusu=u.oficina,`WITH datos AS (
      SELECT uu.idusua, uu.userid, uu.nomusu, uu.telusu, uu.stausu, oo.desofi FROM usuarios uu
      INNER JOIN oficinas oo ON oo.idofic = uu.ofiusu
      WHERE uu.ofiusu = :ofiusu AND
        (uu.nomusu LIKE '%' || :part || '%' OR
        oo.desofi LIKE '%' || :part || '%' OR
        :part IS NULL)
    )
    `):`WITH datos AS (
      SELECT uu.idusua, uu.userid, uu.nomusu, uu.telusu, uu.stausu, oo.desofi FROM usuarios uu
      INNER JOIN oficinas oo ON oo.idofic = uu.ofiusu
      WHERE 
        uu.nomusu LIKE '%' || :part || '%' OR
        oo.desofi LIKE '%' || :part || '%' OR
        :part IS NULL
    )
    `,"next"===u.direction?(a.nomusu=""===u.cursor.next?null:u.cursor.next,s+=`SELECT * FROM datos
    WHERE nomusu > :nomusu OR :nomusu IS NULL
    ORDER BY nomusu ASC
    FETCH NEXT :limit ROWS ONLY`):(a.nomusu=""===u.cursor.prev?null:u.cursor.prev,s+=`SELECT * FROM datos
    WHERE nomusu < CONVERT(:nomusu, 'US7ASCII') OR :nomusu IS NULL
    ORDER BY nomusu DESC
    FETCH NEXT :limit ROWS ONLY
    `),await simpleExecute(s,a));return u?{stat:u.rows.length,data:u.rows}:{stat:0,data:[]}},conEstados=async u=>{var s=estadosSql,s=await simpleExecute(s,u);return s?{stat:1,data:s.rows}:{stat:null,data:null}},insert=async u=>{u.IDUSUA={dir:BIND_OUT,type:NUMBER};var s=await simpleExecute(insertSql,u);return s?(u.IDUSUA=s.outBinds.IDUSUA,{stat:1,data:u}):{stat:0,data:[]}},update=async u=>{return await simpleExecute(updateSql,u)?{stat:1,data:u}:{stat:0,data:[]}},remove=async u=>{return await simpleExecute(removeSql,u)?{stat:1,data:u}:{stat:0,data:[]}},change=async u=>{return await simpleExecute(cambioSql,u)?{stat:1,data:u}:{stat:0,data:[]}},forgot=async u=>{return await simpleExecute(olvidoSql,u)?{stat:1,data:u}:{stat:0,data:[]}},profile=async u=>{return await simpleExecute(perfilSql,u)?{stat:1,data:u}:{stat:0,data:[]}};export{find,findAll,conEstados,insert,update,remove,change,forgot,profile};